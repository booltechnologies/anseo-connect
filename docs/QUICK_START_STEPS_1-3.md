# Quick Start Guide: Steps 1-3

This is a condensed guide for completing Steps 1-3: Database Migrations, Environment Configuration, and Service Bus Setup.

---

## Step 1: Apply Database Migrations ‚ö°

### Prerequisites
- SQL Server instance (local or Azure SQL)
- Valid connection string

### Quick Command

```powershell
cd E:\Development\AnseoConnect

# Option A: Use automation script (recommended)
.\scripts\apply-migrations.ps1

# Option B: Use EF Core CLI directly
dotnet ef database update --project src/Shared/AnseoConnect.Data --startup-project src/Services/AnseoConnect.ApiGateway --context AnseoConnectDbContext
```

### Manual Steps (if script doesn't work)

1. **Configure connection string** in `src/Services/AnseoConnect.ApiGateway/appsettings.json`:
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=<server>;Database=<database>;User Id=<user>;Password=<password>;TrustServerCertificate=True;"
     }
   }
   ```

2. **List migrations** to verify:
   ```powershell
   dotnet ef migrations list --project src/Shared/AnseoConnect.Data --startup-project src/Services/AnseoConnect.ApiGateway --context AnseoConnectDbContext
   ```
   Should show:
   - `20260108090629_Initial`
   - `20260110122806_Step0_AddIdentity`
   - `20260110130326_Step3_AddCommsEntities`
   - `20260110131336_Step4_AddCaseEntities`

3. **Apply migrations**:
   ```powershell
   dotnet ef database update --project src/Shared/AnseoConnect.Data --startup-project src/Services/AnseoConnect.ApiGateway --context AnseoConnectDbContext
   ```

4. **Verify** tables were created (check your database).

### Verification

Run this SQL query to verify tables:
```sql
SELECT name FROM sys.tables 
WHERE name IN ('Tenants', 'Schools', 'Students', 'Guardians', 'AttendanceMarks', 
               'ConsentStates', 'Messages', 'Cases', 'CaseTimelineEvents', 'SafeguardingAlerts')
ORDER BY name;
```

‚úÖ **Success Criteria**: All tables exist in database

---

## Step 2: Configure Environment Variables ‚öôÔ∏è

### For Local Development (Recommended)

Use the automation script:

```powershell
cd E:\Development\AnseoConnect
.\scripts\setup-dev-secrets.ps1
```

This script will:
- Prompt for SQL connection string
- Prompt for Service Bus connection string
- Auto-generate JWT secret
- Prompt for Wonde API token
- Prompt for Twilio credentials
- Set all secrets using `dotnet user-secrets`

### Manual Setup (Alternative)

#### API Gateway

```powershell
cd src/Services/AnseoConnect.ApiGateway
dotnet user-secrets init
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "<sql-connection-string>"
dotnet user-secrets set "ConnectionStrings:ServiceBus" "<servicebus-connection-string>"

# Generate JWT secret
$bytes = New-Object byte[] 32
[System.Security.Cryptography.RandomNumberGenerator]::Fill($bytes)
$jwtSecret = [Convert]::ToBase64String($bytes)
dotnet user-secrets set "Jwt:Secret" $jwtSecret
dotnet user-secrets set "Jwt:Issuer" "AnseoConnect"
dotnet user-secrets set "Jwt:Audience" "AnseoConnect"
```

#### Ingestion.Wonde

```powershell
cd src/Services/AnseoConnect.Ingestion.Wonde
dotnet user-secrets init
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "<sql-connection-string>"
dotnet user-secrets set "ConnectionStrings:ServiceBus" "<servicebus-connection-string>"
dotnet user-secrets set "Wonde:ApiToken" "<wonde-api-token>"
dotnet user-secrets set "Wonde:DefaultDomain" "api.wonde.com"
```

#### Workflow

```powershell
cd src/Services/AnseoConnect.Workflow
dotnet user-secrets init
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "<sql-connection-string>"
dotnet user-secrets set "ConnectionStrings:ServiceBus" "<servicebus-connection-string>"
```

#### Comms

```powershell
cd src/Services/AnseoConnect.Comms
dotnet user-secrets init
dotnet user-secrets set "ConnectionStrings:DefaultConnection" "<sql-connection-string>"
dotnet user-secrets set "ConnectionStrings:ServiceBus" "<servicebus-connection-string>"
dotnet user-secrets set "Twilio:AccountSid" "<twilio-sid>"
dotnet user-secrets set "Twilio:AuthToken" "<twilio-token>"
dotnet user-secrets set "Twilio:FromNumber" "<twilio-phone-number>"
```

### Required Values

| Service | Required Secrets | Notes |
|---------|-----------------|-------|
| **All** | `ConnectionStrings:DefaultConnection` | SQL Server connection string |
| **All** | `ConnectionStrings:ServiceBus` | Service Bus connection string (get from Step 3) |
| **ApiGateway** | `Jwt:Secret` | 256-bit secret (auto-generated by script) |
| **Ingestion.Wonde** | `Wonde:ApiToken` | Get from Wonde support/admin |
| **Comms** | `Twilio:AccountSid` | Get from Twilio Dashboard |
| **Comms** | `Twilio:AuthToken` | Get from Twilio Dashboard |
| **Comms** | `Twilio:FromNumber` | E.164 format (e.g., +1234567890) |

‚úÖ **Success Criteria**: All secrets set, services can start without configuration errors

---

## Step 3: Create Service Bus Topics & Subscriptions üîå

### Option A: Using Automation Script (Recommended)

```powershell
cd E:\Development\AnseoConnect

# Login to Azure first
az login

# Set variables
$resourceGroup = "your-resource-group-name"
$namespace = "your-servicebus-namespace"

# Create topics and subscriptions
.\scripts\create-servicebus-topics.ps1 -ResourceGroupName $resourceGroup -ServiceBusNamespace $namespace
```

The script will:
- Verify namespace exists
- Create topics: `attendance`, `comms`, `workflow`
- Create subscriptions:
  - `workflow-attendance-ingested` on `attendance`
  - `comms-send-message` on `comms`
  - `workflow-message-events` on `comms`
- Display connection string (save this for Step 2)

### Option B: Using Azure Portal (GUI)

#### 1. Create Topics

1. Navigate to Azure Portal ‚Üí Your Service Bus Namespace
2. Click **"Topics"** ‚Üí **"+ Topic"**
3. Create each topic with these settings:
   - **Name**: `attendance` (then `comms`, then `workflow`)
   - **Default message time to live**: `7 days`
   - **Enable duplicate detection**: ‚úÖ Yes
   - **Duplicate detection history**: `10 minutes`

#### 2. Create Subscriptions

**For `attendance` topic:**
1. Click on `attendance` topic
2. Click **"+ Subscription"**
3. **Name**: `workflow-attendance-ingested`
4. **Settings**:
   - Lock duration: `1 minute`
   - Max delivery count: `10`
   - Enable dead lettering on message expiration: ‚úÖ
   - Enable dead lettering on filter evaluation exceptions: ‚úÖ

**For `comms` topic:**
1. Click on `comms` topic
2. Create subscription: `comms-send-message` (same settings as above)
3. Create subscription: `workflow-message-events` (same settings as above)

#### 3. Get Connection String

1. Go to Service Bus Namespace overview
2. Click **"Shared access policies"**
3. Click **"RootManageSharedAccessKey"**
4. Copy **"Primary connection string"**
5. Use this in Step 2 as `ConnectionStrings:ServiceBus`

### Option C: Using Azure CLI (Manual)

```powershell
# Variables
$resourceGroup = "your-resource-group"
$namespace = "your-namespace"

# Create topics
az servicebus topic create --resource-group $resourceGroup --namespace-name $namespace --name attendance --default-message-time-to-live P7D --enable-duplicate-detection true --duplicate-detection-history-time-window PT10M
az servicebus topic create --resource-group $resourceGroup --namespace-name $namespace --name comms --default-message-time-to-live P7D --enable-duplicate-detection true --duplicate-detection-history-time-window PT10M
az servicebus topic create --resource-group $resourceGroup --namespace-name $namespace --name workflow --default-message-time-to-live P7D --enable-duplicate-detection true --duplicate-detection-history-time-window PT10M

# Create subscriptions
az servicebus topic subscription create --resource-group $resourceGroup --namespace-name $namespace --topic-name attendance --name workflow-attendance-ingested --lock-duration PT1M --max-delivery-count 10 --dead-letter-on-message-expiration true --dead-letter-on-filter-evaluation-exceptions true

az servicebus topic subscription create --resource-group $resourceGroup --namespace-name $namespace --topic-name comms --name comms-send-message --lock-duration PT1M --max-delivery-count 10 --dead-letter-on-message-expiration true --dead-letter-on-filter-evaluation-exceptions true

az servicebus topic subscription create --resource-group $resourceGroup --namespace-name $namespace --topic-name comms --name workflow-message-events --lock-duration PT1M --max-delivery-count 10 --dead-letter-on-message-expiration true --dead-letter-on-filter-evaluation-exceptions true

# Get connection string
az servicebus namespace authorization-rule keys list --resource-group $resourceGroup --namespace-name $namespace --name RootManageSharedAccessKey --query primaryConnectionString --output tsv
```

### Prerequisites for Service Bus

- Azure subscription
- Service Bus namespace created (if not, create in Azure Portal)
- Azure CLI installed (`az --version` to check)
- Logged in to Azure (`az login`)

### Verification

After creating topics/subscriptions, verify:

```powershell
# List topics
az servicebus topic list --resource-group <rg> --namespace-name <ns> --output table

# List subscriptions for attendance topic
az servicebus topic subscription list --resource-group <rg> --namespace-name <ns> --topic-name attendance --output table

# List subscriptions for comms topic
az servicebus topic subscription list --resource-group <rg> --namespace-name <ns> --topic-name comms --output table
```

Should show:
- **Topics**: `attendance`, `comms`, `workflow`
- **Subscriptions on `attendance`**: `workflow-attendance-ingested`
- **Subscriptions on `comms`**: `comms-send-message`, `workflow-message-events`

‚úÖ **Success Criteria**: All topics and subscriptions exist, connection string retrieved

---

## Checklist

After completing all steps:

- [ ] **Step 1**: Migrations applied, all tables created in database
- [ ] **Step 2**: All environment variables/user secrets configured for all services
- [ ] **Step 3**: Service Bus topics and subscriptions created, connection string saved
- [ ] **Verification**: Can connect to database and Service Bus from all services
- [ ] **Next**: Ready for Step 4 (Deploy Services) and Step 5 (Integration Testing)

---

## Troubleshooting

### Step 1 Issues

**"Login failed for user"**
- Check SQL connection string
- Verify SQL Server is running
- Check firewall rules (Azure SQL)

**"Database not found"**
- Create database first: `CREATE DATABASE AnseoConnectDev;`
- Or update connection string to point to existing database

### Step 2 Issues

**"User secrets not found"**
- Run `dotnet user-secrets init --project <project-path>` first
- Check you're in the correct directory

**"Access denied"**
- Check user profile permissions
- Try running PowerShell as Administrator

### Step 3 Issues

**"Namespace not found"**
- Verify namespace name
- Check resource group name
- Verify you're logged in to correct subscription: `az account show`

**"Authorization failed"**
- Check you have Contributor or Service Bus Data Owner role
- Try creating namespace manually first in Azure Portal

---

## Next Steps

After completing Steps 1-3:

1. **Start Services Locally:**
   ```powershell
   # Terminal 1: ApiGateway
   dotnet run --project src/Services/AnseoConnect.ApiGateway

   # Terminal 2: Ingestion
   dotnet run --project src/Services/AnseoConnect.Ingestion.Wonde

   # Terminal 3: Workflow
   dotnet run --project src/Services/AnseoConnect.Workflow

   # Terminal 4: Comms
   dotnet run --project src/Services/AnseoConnect.Comms
   ```

2. **Seed Initial Data:**
   
   Use the DataSeeder tool to create development tenant, school, and optionally test users:
   
   ```powershell
   # Basic seeding (tenant and school only)
   dotnet run --project tools/DataSeeder
   
   # With user seeding enabled
   $env:ANSEO_SEED_USERS="true"
   dotnet run --project tools/DataSeeder
   
   # With custom configuration
   $env:ANSEO_SEED_TENANT_NAME="My Tenant"
   $env:ANSEO_SEED_SCHOOL_NAME="My School"
   $env:ANSEO_SEED_WONDE_SCHOOL_ID="your-wonde-id"
   $env:ANSEO_SEED_USERS="true"
   $env:ANSEO_SEED_ADMIN_USERNAME="admin"
   $env:ANSEO_SEED_ADMIN_PASSWORD="SecurePassword123!"
   $env:ANSEO_SEED_ADMIN_EMAIL="admin@example.com"
   dotnet run --project tools/DataSeeder
   ```
   
   See the DataSeeder tool documentation for all available environment variables.

3. **Run Integration Tests:**
   - See `docs/IMPLEMENTATION_STATUS_v0.1.md` for testing checklist

---

## Documentation

- **Detailed Guide**: `docs/DEPLOYMENT_GUIDE_v0.1.md`
- **Scripts Documentation**: `scripts/README.md`
- **Implementation Status**: `docs/IMPLEMENTATION_STATUS_v0.1.md`

---

**Last Updated**: 2025-01-10
