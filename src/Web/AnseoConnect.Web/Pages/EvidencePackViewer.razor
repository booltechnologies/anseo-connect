@page "/evidence/{caseId:guid}"
@using DevExpress.Blazor
@using AnseoConnect.Client

<PageTitle>Evidence Packs</PageTitle>

<h3>Evidence Packs for Case</h3>

<DxGrid Data="@_packs" ShowFilterRow="true" ShowGroupPanel="false">
    <DxGridDataColumn Field="@nameof(EvidencePackDto.GeneratedAtUtc)" Caption="Generated" />
    <DxGridDataColumn Field="@nameof(EvidencePackDto.DateRangeStart)" Caption="Date Range Start" />
    <DxGridDataColumn Field="@nameof(EvidencePackDto.DateRangeEnd)" Caption="Date Range End" />
    <DxGridDataColumn Field="@nameof(EvidencePackDto.GenerationPurpose)" Caption="Purpose" />
    <DxGridDataColumn Field="@nameof(EvidencePackDto.ContentHash)" Caption="Content Hash" />
    <DxGridDataColumn Caption="Actions">
        <CellDisplayTemplate Context="pack">
            <DxButton CssClass="me-2" IconCssClass="dx-icon-download" Click="@(() => DownloadPdf(pack.DataItem as EvidencePackDto))" RenderStyle="ButtonRenderStyle.Secondary" />
            <DxButton IconCssClass="dx-icon-check" Click="@(() => VerifyIntegrity(pack.DataItem as EvidencePackDto))" RenderStyle="ButtonRenderStyle.Secondary" />
        </CellDisplayTemplate>
    </DxGridDataColumn>
</DxGrid>

<DxButton Text="Generate New Pack" NavigateUrl="@($"/evidence/generate/{CaseId}")" />

@if (_verificationResult != null)
{
    <DxPopup @bind-Visible="@_showVerification" HeaderText="Integrity Verification">
        <BodyTemplate Context="popupContent">
            <p>Verification Result: @(_verificationResult.IsValid ? "Valid" : "Invalid")</p>
        </BodyTemplate>
    </DxPopup>
}

@code {
    [Parameter] public Guid CaseId { get; set; }
    [Inject] private EvidenceClient Client { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private List<EvidencePackDto> _packs = new();
    private IntegrityVerificationResult? _verificationResult;
    private bool _showVerification = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadPacks();
    }

    private async Task LoadPacks()
    {
        _packs = await Client.ListEvidencePacksAsync(CaseId);
    }

    private void DownloadPdf(EvidencePackDto? pack)
    {
        if (pack == null) return;
        var url = Client.GetDownloadUrl(CaseId, pack.EvidencePackId);
        Navigation.NavigateTo(url, forceLoad: true);
    }

    private async Task VerifyIntegrity(EvidencePackDto? pack)
    {
        if (pack == null) return;
        var isValid = await Client.VerifyIntegrityAsync(CaseId, pack.EvidencePackId);
        _verificationResult = new IntegrityVerificationResult { IsValid = isValid, PackId = pack.EvidencePackId };
        _showVerification = true;
    }
}
