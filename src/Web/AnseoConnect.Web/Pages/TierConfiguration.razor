@page "/tier-configuration"
@using DevExpress.Blazor
@using AnseoConnect.Client

<PageTitle>Tier Configuration</PageTitle>

<h3>MTSS Tier Definitions</h3>

<DxGrid Data="@_tierDefinitions" ShowFilterRow="true" ShowGroupPanel="false">
    <DxGridDataColumn Field="@nameof(TierDefinitionDto.TierNumber)" Caption="Tier" />
    <DxGridDataColumn Field="@nameof(TierDefinitionDto.Name)" Caption="Name" />
    <DxGridDataColumn Field="@nameof(TierDefinitionDto.Description)" Caption="Description" />
    <DxGridDataColumn Field="@nameof(TierDefinitionDto.ReviewIntervalDays)" Caption="Review Interval (Days)" />
    <DxGridDataColumn Field="@nameof(TierDefinitionDto.IsActive)" Caption="Active" />
</DxGrid>

<DxButton Text="Add Tier Definition" Click="@(() => _showDialog = true)" />

@if (_showDialog)
{
    <DxPopup @bind-Visible="_showDialog" HeaderText="Tier Definition">
        <BodyTemplate Context="popupContext">
            <EditForm Model="@_editingTier" OnValidSubmit="@SaveTier" Context="editContext">
                <DataAnnotationsValidator />
                <DxFormLayout>
                    <DxFormLayoutItem Caption="Tier Number">
                        <DxSpinEdit @bind-Value="@_editingTier.TierNumber" Min="1" Max="3" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Name">
                        <DxTextBox @bind-Value="@_editingTier.Name" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Description">
                        <DxMemo @bind-Value="@_editingTier.Description" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Review Interval (Days)">
                        <DxSpinEdit @bind-Value="@_editingTier.ReviewIntervalDays" Min="1" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Active">
                        <DxCheckBox T="bool" @bind-Value="@_editingTier.IsActive" />
                    </DxFormLayoutItem>
                </DxFormLayout>
                <DxButton Text="Save" SubmitFormOnEnter="true" />
                <DxButton Text="Cancel" RenderStyle="ButtonRenderStyle.Secondary" Click="@(() => _showDialog = false)" />
            </EditForm>
        </BodyTemplate>
    </DxPopup>
}

@code {
    [Inject] private TierClient Client { get; set; } = default!;

    private List<TierDefinitionDto> _tierDefinitions = new();
    private bool _showDialog = false;
    private TierDefinitionDto _editingTier = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTiers();
    }

    private async Task LoadTiers()
    {
        _tierDefinitions = await Client.GetTierDefinitionsAsync();
    }

    private async Task SaveTier()
    {
        if (_editingTier.TierDefinitionId == Guid.Empty)
        {
            await Client.CreateTierDefinitionAsync(_editingTier);
        }
        else
        {
            await Client.UpdateTierDefinitionAsync(_editingTier.TierDefinitionId, _editingTier);
        }
        _showDialog = false;
        await LoadTiers();
    }
}
