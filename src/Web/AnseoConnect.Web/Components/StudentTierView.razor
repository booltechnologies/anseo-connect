@using DevExpress.Blazor
@using AnseoConnect.Client

@if (_currentTier != null)
{
    <div class="dx-card p-3 mb-3">
        <h5>Current Tier: @_currentTier.TierNumber</h5>
        <p><strong>Rationale:</strong> @_currentTier.Rationale</p>
        <p><strong>Assigned:</strong> @_currentTier.AssignedAtUtc.ToString("yyyy-MM-dd")</p>
        <p><strong>Reason:</strong> @_currentTier.AssignmentReason</p>
    </div>

    <h6>Tier History</h6>
    <DxGrid Data="@_history" ShowFilterRow="false" ShowGroupPanel="false">
        <DxGridDataColumn Field="@nameof(TierAssignmentHistoryDto.ChangedAtUtc)" Caption="Date" />
        <DxGridDataColumn Field="@nameof(TierAssignmentHistoryDto.ChangeType)" Caption="Change Type" />
        <DxGridDataColumn Field="@nameof(TierAssignmentHistoryDto.FromTier)" Caption="From Tier" />
        <DxGridDataColumn Field="@nameof(TierAssignmentHistoryDto.ToTier)" Caption="To Tier" />
        <DxGridDataColumn Field="@nameof(TierAssignmentHistoryDto.ChangeReason)" Caption="Reason" />
    </DxGrid>
}
else
{
    <p>No tier assignment found.</p>
}

<DxButton Text="Evaluate Tier" Click="@EvaluateTier" />

@code {
    [Parameter] public Guid CaseId { get; set; }
    [Inject] private TierClient Client { get; set; } = default!;

    private TierAssignmentDto? _currentTier;
    private List<TierAssignmentHistoryDto> _history = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTierData();
    }

    private async Task LoadTierData()
    {
        _currentTier = await Client.GetCurrentTierAsync(CaseId);
        _history = await Client.GetTierHistoryAsync(CaseId);
    }

    private async Task EvaluateTier()
    {
        var evaluation = await Client.EvaluateTierAsync(CaseId);
        // Could show evaluation results in a popup or update the display
        await LoadTierData();
    }
}
